generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum PenVisibility {
  PRIVATE
  UNLISTED
  PUBLIC
}

enum RevisionKind {
  AUTOSAVE
  SNAPSHOT
  FORK
}

model User {
  id              String        @id @default(uuid()) @db.Uuid
  email           String        @unique @db.Citext
  passwordHash    String        @map("password_hash")
  displayName     String?       @map("display_name")
  role            UserRole      @default(USER)
  emailVerifiedAt DateTime?     @map("email_verified_at")
  settings        Json?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  sessions        Session[]
  pens            Pen[]
  revisions       PenRevision[] @relation("PenRevisionAuthor")
  settingsProfile UserSettings?
  auditEvents     AuditEvent[]

  @@map("users")
}

model Session {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  sessionToken String   @unique @map("session_token")
  expiresAt   DateTime  @map("expires_at")
  ip          String?
  userAgent   String?   @map("user_agent")
  lastSeenAt  DateTime? @map("last_seen_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user        User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("sessions")
}

model Pen {
  id            String        @id @default(uuid()) @db.Uuid
  ownerId       String        @map("owner_id") @db.Uuid
  title         String
  slug          String?       @unique
  visibility    PenVisibility @default(PRIVATE)
  forkedFromId  String?       @map("forked_from_id") @db.Uuid
  tagsCache     String[]      @default([]) @map("tags_cache") @db.Text
  previewHash   String?       @map("preview_hash")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  owner         User          @relation(fields: [ownerId], references: [id])
  revisions     PenRevision[]
  forkedFrom    Pen?          @relation("PenFork", fields: [forkedFromId], references: [id])
  forks         Pen[]         @relation("PenFork")
  tags          PenTag[]

  @@index([ownerId, updatedAt(sort: Desc)])
  @@map("pens")
}

model PenRevision {
  id           String        @id @default(uuid()) @db.Uuid
  penId        String        @map("pen_id") @db.Uuid
  authorId     String        @map("author_id") @db.Uuid
  revNumber    Int           @map("rev_number")
  kind         RevisionKind
  html         String        @db.Text
  css          String        @db.Text
  js           String        @db.Text
  meta         Json?
  compiledHash String?       @map("compiled_hash")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  pen          Pen           @relation(fields: [penId], references: [id])
  author       User          @relation("PenRevisionAuthor", fields: [authorId], references: [id])

  @@unique([penId, revNumber])
  @@index([penId, createdAt(sort: Desc)])
  @@map("pen_revisions")
}

model Tag {
  id         Int      @id @default(autoincrement())
  slug       String   @unique
  label      String
  usageCount Int      @default(0) @map("usage_count")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  penTags    PenTag[]

  @@map("tags")
}

model PenTag {
  penId String @map("pen_id") @db.Uuid
  tagId Int    @map("tag_id")

  pen   Pen    @relation(fields: [penId], references: [id])
  tag   Tag    @relation(fields: [tagId], references: [id])

  @@id([penId, tagId])
  @@map("pen_tags")
}

model UserSettings {
  userId       String   @id @map("user_id") @db.Uuid
  editorLayout Json?    @map("editor_layout")
  featureFlags Json?    @map("feature_flags")
  updatedAt    DateTime @default(now()) @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@map("user_settings")
}

model AuditEvent {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  eventType String   @map("event_type")
  payload   Json?
  ip        String?
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("audit_events")
}
